name: Release Helm Charts

on:
  push:
    branches:
      - main
    paths:
      - 'charts/**'

jobs:
  release:
    permissions:
      contents: write
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

      - name: Detect Changed Charts
        id: detect-charts
        run: |
          CHANGED=$(git diff --name-only HEAD~1 HEAD | grep '^charts/' || true)
          echo "Changed files: $CHANGED"
          if [ -n "$CHANGED" ]; then
            echo "charts_changed=true" >> $GITHUB_OUTPUT
          else
            echo "charts_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Auto-bump versions of changed charts
        if: steps.detect-charts.outputs.charts_changed == 'true'
        run: |
          DATE=$(date +'%d-%m-%Y')
          HASH=$(git rev-parse --short HEAD)
          RUN_NUMBER=${{ github.run_number }}
          VERSION="$DATE-$HASH-$RUN_NUMBER"

          CHANGED_DIRS=$(git diff --name-only HEAD~1 HEAD | grep '^charts/' | cut -d/ -f2 | uniq)

          for DIR in $CHANGED_DIRS; do
            CHART="charts/$DIR/Chart.yaml"
            echo "Updating version in $CHART to $VERSION"
            sed -i "s/^version:.*/version: \"$VERSION\"/" "$CHART"
            sed -i "s/^appVersion:.*/appVersion: \"$VERSION\"/" "$CHART"
          done

          git add charts/**/Chart.yaml
          git commit -m "Auto-bump chart versions to $VERSION"
          git push

      - name: Run chart-releaser
        if: steps.detect-charts.outputs.charts_changed == 'true'
        uses: helm/chart-releaser-action@v1.7.0
        with:
          charts_dir: charts
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

